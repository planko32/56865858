<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Withdraw - EXARAI</title>
  <link rel="stylesheet" href="withdraw-style.css" />
</head>
<body>
  <div class="app">
    <header class="app-header">
      <a href="javascript:history.back()" class="back-btn">
        <div class="back-arrow"></div>
      </a>
      <div class="app-header-title">Withdraw</div>
      <div class="header-icon">â§‰</div>
    </header>

    <main class="app-main">
      <div class="section-label">Withdrawal Currency</div>
      <div class="select-box">
        <span class="select-value">USDT</span>
        <span class="chevron">â–¾</span>
      </div>

      <div class="section-label">Withdrawal Network</div>
      <div class="network-row">
        <button type="button" class="network-pill">TRC20</button>
      </div>

      <div class="section-label">Withdrawal Address</div>
      <div class="select-box address-row">
        <span class="select-placeholder">Please select an address</span>
        <div class="address-icon">ðŸ‘¤</div>
        <span class="chevron">â–¾</span>
      </div>

      <button type="button" class="add-address-btn">Add address</button>

      <div class="section-label">Quantity</div>
      <div class="select-box qty-box">
        <input class="qty-input" id="qtyInput" type="number" min="0" step="0.01"
               placeholder="Enter Withdrawal Quantity" />
        <div class="qty-right">
          <span class="qty-unit">USDT</span>
          <span class="qty-max" id="maxLink">MAX</span>
        </div>
      </div>

      <div class="available-row">
        Available <span class="value" id="availableVal">3.06 USDT</span>
      </div>

      <div class="info-card">
        <div class="info-row">
          <span>Minimum Withdrawal Quantity</span>
          <span><span id="minQty">20</span> USDT</span>
        </div>
        <div class="info-row">
          <span>Withdrawal Fee</span>
          <span><span id="feeVal">0</span> USDT</span>
        </div>
        <div class="info-row">
          <span>Received Quantity</span>
          <span><span id="recvVal">0</span> USDT</span>
        </div>
      </div>

      <button type="button" class="withdraw-btn" id="withdrawBtn">Withdraw</button>

      <div class="reminder-title">Friendly Reminder</div>
      <ol class="reminder-list">
        <li>The minimum withdrawal amount is: <span class="reminder-em">20 USDT</span></li>
        <li>Withdrawal fee: <span class="reminder-em">5%</span></li>
        <li>Withdrawals will arrive within 2â€“120 hours.</li>
        <li>After completing <span class="reminder-em">6</span> AI computing power tasks, you can apply for withdrawal.</li>
        <li>Make sure your computer and browser are secure to prevent information from being tampered with or leaked.</li>
        <li>Before withdrawing coins, please confirm whether the withdrawal address is safe and corresponds to the current currency. Once the address of a nonâ€‘TRC20 network is used, the platform cannot help to retrieve it. Please check carefully before withdrawing coins.</li>
      </ol>
    </main>
  </div>

  
  <script src="wallet.js"></script>
  
  <script>
    (function() {
      var qtyInput = document.getElementById('qtyInput');
      var feeVal = document.getElementById('feeVal');
      var recvVal = document.getElementById('recvVal');
      var minQty = 20;
      var maxAvailable = 0;
      var maxLink = document.getElementById('maxLink');
      var withdrawBtn = document.getElementById('withdrawBtn');
      var availableVal = document.getElementById('availableVal');
      var addressBox = document.querySelector('.select-box.address-row');
      var addAddressBtn = document.querySelector('.add-address-btn');
      var addressPlaceholder = addressBox ? addressBox.querySelector('.select-placeholder') : null;

      var selectedAddress = null;
      var ADDR_KEY = 'withdrawAddresses_v1';
      var ADDR_SELECTED_KEY = 'withdrawSelectedAddress_v1';


      var balance = 0;

      var WITHDRAW_FEE_RATE = 0.05;
      var COOLDOWN_WITHDRAW_DAYS = 3;   // 3 days between withdrawals
      var COOLDOWN_EARN_HOURS = 3;      // 3 hours after last AI Power earning

      function syncBalance() {
        if (window.DemoWallet && typeof window.DemoWallet.getWallet === 'function') {
          var w = DemoWallet.getWallet();
          if (w && typeof w.balance === 'number') {
            balance = w.balance;
          }
        }
        maxAvailable = balance;
        if (availableVal) {
          availableVal.textContent = balance.toFixed(2) + ' USDT';
        }
      }

      function updateValues() {
        if (!qtyInput) return;
        var v = parseFloat(qtyInput.value);
        if (isNaN(v) || v <= 0) {
          feeVal.textContent = '0';
          recvVal.textContent = '0';
          return;
        }
        var fee = v * WITHDRAW_FEE_RATE;
        var received = v - fee;
        feeVal.textContent = fee.toFixed(2);
        recvVal.textContent = received.toFixed(2);
      }

      function getLastTxTime(type) {
        try {
          if (!window.DemoWallet || typeof DemoWallet.getTransactions !== 'function') {
            return null;
          }
          var txs = DemoWallet.getTransactions() || [];
          for (var i = 0; i < txs.length; i++) {
            var tx = txs[i];
            if (tx && tx.type && tx.type.toLowerCase() === type.toLowerCase() && tx.createdAt) {
              var d = new Date(tx.createdAt);
              if (!isNaN(d.getTime())) {
                return d;
              }
            }
          }
        } catch (e) {
          console.warn('getLastTxTime error', e);
        }
        return null;
      }


      function loadAddresses() {
        try {
          var raw = localStorage.getItem(ADDR_KEY);
          if (!raw) return [];
          var arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return [];
          return arr;
        } catch (e) {
          console.warn('loadAddresses error', e);
          return [];
        }
      }

      function saveAddresses(list) {
        try {
          localStorage.setItem(ADDR_KEY, JSON.stringify(list || []));
        } catch (e) {
          console.warn('saveAddresses error', e);
        }
      }

      function loadSelectedAddress() {
        try {
          var a = localStorage.getItem(ADDR_SELECTED_KEY);
          return a || null;
        } catch (e) {
          return null;
        }
      }

      function setSelectedAddress(addr) {
        selectedAddress = addr || null;
        try {
          if (addr) {
            localStorage.setItem(ADDR_SELECTED_KEY, addr);
          } else {
            localStorage.removeItem(ADDR_SELECTED_KEY);
          }
        } catch (e) {}
        updateAddressUI();
      }

      function maskAddress(addr) {
        if (!addr) return 'Please select an address';
        addr = String(addr);
        if (addr.length <= 10) return addr;
        return addr.slice(0, 4) + '****' + addr.slice(-4);
      }

      function updateAddressUI() {
        if (!addressPlaceholder) return;
        if (selectedAddress) {
          addressPlaceholder.textContent = maskAddress(selectedAddress);
        } else {
          addressPlaceholder.textContent = 'Please select an address';
        }
      }
      if (qtyInput) {
        qtyInput.addEventListener('input', updateValues);
      }

      if (maxLink) {
        maxLink.addEventListener('click', function() {
          qtyInput.value = maxAvailable.toFixed(2);
          updateValues();
        });
      }


      if (addAddressBtn) {
        addAddressBtn.addEventListener('click', function() {
          var addr = prompt('Enter withdrawal address (USDT TRC20):');
          if (!addr) return;
          addr = addr.trim();
          if (!addr) return;
          var list = loadAddresses();
          if (list.indexOf(addr) === -1) {
            list.push(addr);
          }
          saveAddresses(list);
          setSelectedAddress(addr);
          alert('Withdrawal address saved.');
        });
      }

      if (addressBox) {
        addressBox.addEventListener('click', function() {
          var list = loadAddresses();
          if (!list.length) {
            alert('No saved addresses. Please add an address first.');
            return;
          }
          var idx = -1;
          if (selectedAddress) {
            idx = list.indexOf(selectedAddress);
          }
          idx = (idx + 1) % list.length;
          setSelectedAddress(list[idx]);
        });
      }

      if (withdrawBtn) {
        withdrawBtn.addEventListener('click', function() {
          if (!window.DemoWallet ||
              typeof window.DemoWallet.getWallet !== 'function' ||
              typeof window.DemoWallet.withdraw !== 'function') {
            alert('Internal error: wallet not available.');
            return;
          }


          if (!selectedAddress) {
            alert('Please add and select a withdrawal address first.');
            return;
          }

          var v = parseFloat(qtyInput.value);
          if (isNaN(v) || v <= 0) {
            alert('Please enter a valid amount.');
            return;
          }

          if (v < minQty) {
            alert('The minimum withdrawal amount is ' + minQty + ' USDT.');
            return;
          }

          if (v > balance) {
            alert('Insufficient balance.');
            return;
          }

          var wCheck = DemoWallet.getWallet();
          if (!wCheck || typeof wCheck.totalIncome !== 'number' || wCheck.totalIncome < 6) {
            alert('You can apply for withdrawal only after completing 6 AI computing power tasks.');
            return;
          }

          // Check cooldown after last AI Power earning (income)
          var now = new Date();
          var lastIncome = getLastTxTime('income');
          if (lastIncome) {
            var diffHours = (now - lastIncome) / (1000 * 60 * 60);
            if (diffHours < COOLDOWN_EARN_HOURS) {
              alert('You can withdraw only after ' + COOLDOWN_EARN_HOURS +
                    ' hours from your last AI Power earning.');
              return;
            }
          }

          // Check last withdrawal time (3-day rule)
          var lastWithdraw = getLastTxTime('withdraw');
          if (lastWithdraw) {
            var diffDays = (now - lastWithdraw) / (1000 * 60 * 60 * 24);
            if (diffDays < COOLDOWN_WITHDRAW_DAYS) {
              alert('You can withdraw once every ' + COOLDOWN_WITHDRAW_DAYS +
                    ' days. Please try again later.');
              return;
            }
          }

var result = DemoWallet.withdraw(v);
          if (!result) {
            alert('Withdrawal failed, please try again.');
            return;
          }

          balance = result.balance || 0;
          maxAvailable = balance;
          if (availableVal) {
            availableVal.textContent = balance.toFixed(2) + ' USDT';
          }

          if (qtyInput) {
            qtyInput.value = '';
          }
          updateValues();

                    alert('Withdrawal request submitted and is pending review (2â€“120 hours).');
     }
        });
      }

      // initial sync
      selectedAddress = loadSelectedAddress();
      updateAddressUI();
      syncBalance();
      updateValues();
    })();
  </script>



  <script src="auth.js"></script>
<script src="common-nav.js"></script>
</body>
</html>
